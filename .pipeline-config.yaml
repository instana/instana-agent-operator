#
# (c) Copyright IBM Corp. 2025
#
version: "2"

tasks:
  pr-code-checks:
    displayName: build-images-and-e2e
    runtimeClassName: large
    onError: stopAndFail
    include:
      - dind
    steps:
      - name: unit-test
        image: icr.io/continuous-delivery/pipeline/pipeline-base-ubi:3
        include:
          - docker-socket
        script: |
          #!/usr/bin/env bash
          export TASK_NAME="pr-code-checks"
          export SKIP_INSTALL_GCLOUD="false"
          source "${WORKSPACE}/${APP_REPO_FOLDER}/ci/sps-scripts/setup.sh"
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/sps-build-multiarch-images.sh
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/vm-janitor.sh
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/ephemeral-k8s-e2e.sh
      - name: detect-secrets
        include:
          - docker-socket
    
  pr-code-checks-2:
    from: pr-code-checks
    displayName: go-lang-unit-test
    runtimeClassName: large
    onError: stopAndFail
    include:
      - dind
    steps:
      - name: unit-test
        image: icr.io/continuous-delivery/pipeline/pipeline-base-ubi:3
        include:
          - docker-socket
        script: |
          #!/usr/bin/env bash
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/unit-test.sh          
      - name: detect-secrets
        include:
          - docker-socket
          
  pr-code-checks-3:
    from: pr-code-checks
    displayName: operator-olm-build
    runtimeClassName: large
    include:
      - dind
    steps:
      - name: unit-test
        image: icr.io/continuous-delivery/pipeline/pipeline-base-ubi:3
        include:
          - docker-socket
        script: |
          #!/usr/bin/env bash
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/olm-build.sh
      - name: detect-secrets
        include:
          - docker-socket

  code-pr-finish:
    steps:
      - name: evaluate
        when: 'false'
      - name: prepare
        when: 'false'
      - name: run-stage
        when: 'false'

  e2e-tests:
    displayName: run-e2e-tests
    runtimeClassName: large
    onError: stopAndFail
    include:
      - dind
    # Remove the properties section completely
    steps:
      - name: run-e2e-tests
        image: icr.io/continuous-delivery/pipeline/pipeline-base-ubi:3
        include:
          - docker-socket
        script: |
          #!/usr/bin/env bash
          export TASK_NAME="e2e-tests"
          
          # Debug information
          echo "Current environment:"
          env
          echo "Current directory:"
          pwd
          echo "Directory contents:"
          ls -la
          
          # Check if trigger payload exists and extract branch
          echo "Trigger payload path: ${TRIGGER_PAYLOAD_PATH}"
          if [ -f "${TRIGGER_PAYLOAD_PATH}" ]; then
            echo "Trigger payload content:"
            cat "${TRIGGER_PAYLOAD_PATH}"
            
            # Try different methods to extract branch
            BRANCH=$(cat "${TRIGGER_PAYLOAD_PATH}" | grep -o '"branch":"[^"]*"' | cut -d'"' -f4)
            
            # If grep method fails, try a simpler approach
            if [ -z "$BRANCH" ]; then
              BRANCH=$(cat "${TRIGGER_PAYLOAD_PATH}" | tr ',' '\n' | grep '"branch"' | cut -d'"' -f4)
            fi
            
            # If still empty, use default
            if [ -z "$BRANCH" ]; then
              BRANCH="main"
              echo "No branch found in payload, using default: $BRANCH"
            else
              echo "Found branch in payload: $BRANCH"
            fi
          else
            BRANCH="main"
            echo "No trigger payload found, using default branch: $BRANCH"
          fi
          
          echo "Running E2E tests for branch: $BRANCH"
          
          # Checkout the specified branch
          git fetch origin $BRANCH
          git checkout $BRANCH
          
          # Run your E2E test script
          export CLUSTER_ID="gke-latest"
          export SKIP_INSTALL_GCLOUD="false"
          source $WORKSPACE/$APP_REPO_FOLDER/ci/sps-scripts/e2e.sh