#
# (c) Copyright IBM Corp. 2025
#
---
groups:
  - name: public-pr-creation
    jobs:
    - self-update
    - olm-release-pr-creation
  - name: build-test-images
    jobs:
    - build-e2e-operator-base-image

var:
  instana-operator-git-repo-config: &instana-operator-git-repo-config
    uri: https://github.com/instana/instana-agent-operator.git
    branch: main
    username: instanacd
    password: ((instanacd-github-api-token))

resource_types:
  - name: cogito
    type: registry-image
    check_every: never
    source:
      repository: delivery.instana.io/int-docker-cogito-instana-local/cogito
      tag: latest
      username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
      password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
  - name: key-value
    type: registry-image
    source:
      repository: gstack/keyval-resource
  - name: slack-notification
    type: registry-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:
  - name: slack-alert
    type: slack-notification
    source:
      url: ((tech-agent-delivery-notifications-slack-hook))

  - name: agent-operator-git-source
    type: git
    icon: github
    source:
      <<: *instana-operator-git-repo-config

  - name: agent-operator-ci-git-source
    type: git
    icon: github
    source:
      <<: *instana-operator-git-repo-config
      paths:
      - ci/images/e2e-base-image/*
      - ci/release-pr-creation-and-e2e-image-build.yaml

  - name: agent-operator-release-source
    type: git
    icon: github
    source:
      <<: *instana-operator-git-repo-config
      fetch_tags: true
      #  match release tags like "v1.12.99"
      #  match pre-release tags like "v1.12.100-pre"
      tag_regex: '^v\d+\.\d+\.\d+.*$'
      #          ^ beginning of the tag string
      #           ^ all tags start with "v"
      #            ^ ^ any number of digits
      #               ^ the "." character
      #                 ^ ^ any number of digits
      #                    ^ the "." character
      #                      ^ ^ any number of digits
      #                         ^^ any prefix (denoting a non-release tag)
      #                           ^ end of the tag string

  - name: instana-agent-operator-release
    type: github-release
    source:
      owner: instana
      repository: instana-agent-operator
      order_by: version

  - name: gh-status
    type: cogito
    source:
      owner: instana
      repo: instana-agent-operator
      access_token: ((instanacd-github-api-token))
      context_prefix: concourse
      github_host: github.com

  - name: e2e-test-base-image
    type: registry-image
    icon: cube
    source: &e2e-test-base-image
      repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
      username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
      password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
      tag: main

  - name: community-operators-repo
    type: git
    icon: github
    source:
      uri: https://github.com/instana/community-operators.git
      branch: main
      username: instanacd
      password: ((instanacd-github-api-token))

  - name: certified-operators-repo
    type: git
    icon: github
    source:
      uri: https://github.com/instana/certified-operators.git
      branch: main
      username: instanacd
      password: ((instanacd-github-api-token))

  - name: redhat-marketplace-operators-repo
    type: git
    icon: github
    source:
      uri: https://github.com/instana/redhat-marketplace-operators.git
      branch: main
      username: instanacd
      password: ((instanacd-github-api-token))

jobs:
  - name: self-update
    on_success:
      put: gh-status
      inputs: [ agent-operator-ci-git-source ]
      params: { state: success, context: self-update }
    on_failure:
      do:
        - put: slack-alert
          params:
            channel: '#tech-agent-delivery-notifications'
            text: |
              :x: the operator self-update has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
        - put: gh-status
          inputs: [ agent-operator-ci-git-source ]
          params: { state: failure, context: self-update }
    on_error:
      do:
        - put: slack-alert
          params:
            channel: '#tech-agent-delivery-notifications'
            text: |
              :x: the operator self-update has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
        - put: gh-status
          inputs: [ agent-operator-ci-git-source ]
          params: { state: error, context: self-update }
    on_abort:
      put: gh-status
      inputs: [ agent-operator-ci-git-source ]
      params: { state: error, context: self-update }
    plan:
      - get: agent-operator-ci-git-source
        trigger: true
      - put: gh-status
        inputs: [ agent-operator-ci-git-source ]
        params: { state: pending, context: self-update }
      - put: gh-status
        inputs: [ agent-operator-ci-git-source ]
        params: { state: pending, context: operator-olm-release-pr-creation/build }
      - set_pipeline: self
        file: agent-operator-ci-git-source/ci/release-pr-creation-and-e2e-image-build.yaml

  - name: olm-release-pr-creation
    max_in_flight: 1
    plan:
      - get: instana-agent-operator-release
        trigger: true
        params:
          globs:
            - olm-*.zip
      - get: agent-operator-release-source
        passed: [operator-olm-github-release]
      - get: agent-operator-git-source
      - in_parallel:
          steps:
            - do:
                - get: community-operators-repo
                - task: community-operators-rebase
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: community-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: community-operators-repo
                    params:
                      OWNER: k8s-operatorhub
                      REPO: community-operators
                      PUBLIC_REPO_LOCAL_NAME: community-operators-repo
                    run:
                      path: agent-operator-git-source/ci/scripts/rebase-fork-branches.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/community-operators-rebase }
                      - put: community-operators-repo
                        params:
                          repository: community-operators-repo
                          force: true
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/community-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/community-operators-rebase }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/community-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/community-operators-rebase }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/community-operators-rebase }
                - task: community-operators-commit-changes-and-create-pr
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: community-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: community-operators-repo
                    params:
                      GH_API_TOKEN: ((instanacd-github-api-token))
                      USERNAME: instanacd
                      OWNER: k8s-operatorhub
                      REPO: community-operators
                      PUBLIC_REPO_LOCAL_NAME: community-operators-repo
                      OPERATOR_NAME: instana-agent-operator
                    run:
                      path: agent-operator-git-source/ci/scripts/commit-changes-to-public-repo.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/community-operators-commit-changes }
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/community-operators-commit-changes-and-create-pr has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/community-operators-commit-changes }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/community-operators-commit-changes-and-create-pr has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/community-operators-commit-changes }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/community-operators-commit-changes }
            - do:
                - get: certified-operators-repo
                - task: certified-operators-rebase
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: certified-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: certified-operators-repo
                    params:
                      OWNER: redhat-openshift-ecosystem
                      REPO: certified-operators
                      PUBLIC_REPO_LOCAL_NAME: certified-operators-repo
                    run:
                      path: agent-operator-git-source/ci/scripts/rebase-fork-branches.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/certified-operators-rebase }
                      - put: certified-operators-repo
                        params:
                          repository: certified-operators-repo
                          force: true
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/certified-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/certified-operators-rebase }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/certified-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/certified-operators-rebase }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/certified-operators-rebase }
                - task: certified-operators-commit-changes-and-create-pr
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: certified-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: certified-operators-repo
                    params:
                      GH_API_TOKEN: ((instanacd-github-api-token))
                      USERNAME: instanacd
                      OWNER: redhat-openshift-ecosystem
                      REPO: certified-operators
                      PUBLIC_REPO_LOCAL_NAME: certified-operators-repo
                      OPERATOR_NAME: instana-agent-operator
                    run:
                      path: agent-operator-git-source/ci/scripts/commit-changes-to-public-repo.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/certified-operators-commit-changes }
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/certified-operators-commit-changes-and-create-pr has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/certified-operators-commit-changes }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/certified-operators-commit-changes has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/certified-operators-commit-changes }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/certified-operators-commit-changes }
            - do:
                - get: redhat-marketplace-operators-repo
                - task: redhat-marketplace-operators-rebase
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: redhat-marketplace-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: redhat-marketplace-operators-repo
                    params:
                      OWNER: redhat-openshift-ecosystem
                      REPO: redhat-marketplace-operators
                      PUBLIC_REPO_LOCAL_NAME: redhat-marketplace-operators-repo
                    run:
                      path: agent-operator-git-source/ci/scripts/rebase-fork-branches.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/redhat-marketplace-operators-rebase }
                      - put: redhat-marketplace-operators-repo
                        params:
                          repository: redhat-marketplace-operators-repo
                          force: true
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/redhat-marketplace-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/redhat-marketplace-operators-rebase }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/redhat-marketplace-operators-rebase has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/redhat-marketplace-operators-rebase }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/redhat-marketplace-operators-rebase }
                - task: redhat-marketplace-operator-commit-changes-and-create-pr
                  config:
                    platform: linux
                    image_resource:
                      type: registry-image
                      source:
                        repository: delivery.instana.io/int-docker-agent-local/instana-agent-operator/e2e-test-base-image
                        tag: main
                        username: ((delivery-instana-io-internal-project-artifact-read-writer-creds.username))
                        password: ((delivery-instana-io-internal-project-artifact-read-writer-creds.password))
                    inputs:
                      - name: instana-agent-operator-release
                      - name: redhat-marketplace-operators-repo
                      - name: agent-operator-git-source
                    outputs:
                      - name: redhat-marketplace-operators-repo
                    params:
                      GH_API_TOKEN: ((instanacd-github-api-token))
                      USERNAME: instanacd
                      OWNER: redhat-openshift-ecosystem
                      REPO: redhat-marketplace-operators
                      PUBLIC_REPO_LOCAL_NAME: redhat-marketplace-operators-repo
                      OPERATOR_NAME: instana-agent-operator-rhmp
                    run:
                      path: agent-operator-git-source/ci/scripts/commit-changes-to-public-repo.sh
                  on_success:
                    do:
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: success, context: olm-release-pr-creation/redhat-marketplace-operator-commit-changes }
                  on_failure:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/redhat-marketplace-operator-commit-changes-and-create-pr has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: failure, context: olm-release-pr-creation/redhat-marketplace-operator-commit-changes }
                  on_error:
                    do:
                      - put: slack-alert
                        params:
                          channel: '#tech-agent-delivery-notifications'
                          text: |
                            :x: The operator olm-release-pr-creation/redhat-marketplace-operator-commit-changes-and-create-pr has failed. <!subteam^SNMD75GH3> please check <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|the build job>.
                      - put: gh-status
                        inputs: [ agent-operator-git-source ]
                        params: { state: error, context: olm-release-pr-creation/redhat-marketplace-operator-commit-changes }
                  on_abort:
                    put: gh-status
                    inputs: [ agent-operator-git-source ]
                    params: { state: error, context: olm-release-pr-creation/redhat-marketplace-operator-commit-changes }

  - name: build-e2e-operator-base-image
    max_in_flight: 1
    plan:
      - get: agent-operator-ci-git-source
        trigger: true
        passed: [self-update]
      - task: build-e2e-operator-base-image
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: vito/oci-build-task
          params:
            CONTEXT: agent-operator-ci-git-source/ci/images/e2e-base-image
            DOCKERFILE: agent-operator-ci-git-source/ci/images/e2e-base-image/Dockerfile
          inputs:
          - name: agent-operator-ci-git-source
          outputs:
          - name: image
          run:
            path: build
      - put: e2e-test-base-image
        inputs: detect
        params:
          image: image/image.tar
        get_params:
          skip_download: true
